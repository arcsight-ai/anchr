# ANCHR PR Commenter (Clean Final). One comment per PR. Fork-safe. Non-blocking.
name: ANCHR PR Comment

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  anchr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    concurrency:
      group: anchr-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    timeout-minutes: 12

    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0

      - name: Skip if draft
        id: skip_draft
        run: |
          if [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if anchr-ignore or disabled
        id: skip_flags
        if: steps.skip_draft.outputs.skip != 'true'
        run: |
          SKIP=false
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          if echo "$LABELS" | grep -q '"anchr-ignore"'; then SKIP=true; fi
          if [ "${{ vars.ANCHR_DISABLED }}" = "true" ]; then SKIP=true; fi
          echo "skip=$SKIP" >> $GITHUB_OUTPUT

      - name: Fetch head (for diff only)
        if: steps.skip_draft.outputs.skip != 'true' && steps.skip_flags.outputs.skip != 'true'
        run: |
          git fetch origin ${{ github.event.pull_request.head.sha }} --depth=1

      - name: Setup Node
        if: steps.skip_draft.outputs.skip != 'true' && steps.skip_flags.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run structural audit (report for comment)
        if: steps.skip_draft.outputs.skip != 'true' && steps.skip_flags.outputs.skip != 'true'
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          ANCHR_REPORT_PATH: ${{ github.workspace }}/artifacts/anchr-report.json
        run: |
          mkdir -p artifacts
          npx -y tsx@4.19.2 scripts/anchr-structural-audit.ts || true
        continue-on-error: true

      - name: Run Dina certification
        if: steps.skip_draft.outputs.skip != 'true' && steps.skip_flags.outputs.skip != 'true'
        env:
          REPORT_PATH: ${{ github.workspace }}/artifacts/determinism-report.json
        run: |
          mkdir -p artifacts
          npx -y tsx@4.19.2 scripts/dina.ts certify --base "${{ github.event.pull_request.base.sha }}" --head "${{ github.event.pull_request.head.sha }}" --runs 8 || true
        continue-on-error: true

      - name: ANCHR PR comment (clean)
        if: steps.skip_draft.outputs.skip != 'true' && steps.skip_flags.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          REPORT_PATH: ${{ github.workspace }}/artifacts/anchr-report.json
        run: npx -y tsx@4.19.2 scripts/anchr-pr-comment-clean.ts
        continue-on-error: true
