# ANCHR architectural policy enforcement (Prompt 14).
# Deterministic, fork-safe, rerun-safe. Uses curl + token only; no gh CLI.
# Comment and check run are best-effort; policy is enforced by check result.

name: ANCHR

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  anchr:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    concurrency:
      group: anchr-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Checkout trusted base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0

      - name: Fetch PR head safely
        run: |
          git fetch origin ${{ github.event.pull_request.head.sha }} --depth=1
          git checkout ${{ github.event.pull_request.head.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run ANCHR
        run: |
          npx -y tsx@4 scripts/anchr-structural-audit.ts || true
          npx -y tsx@4 scripts/anchr-decision.ts || true
          npx -y tsx@4 scripts/anchr-fix-suggestions.ts || true
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}

      - name: Publish ANCHR status
        if: always() && github.event_name == 'pull_request_target'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ANCHR_REPORT_PATH: ${{ github.workspace }}/artifacts/anchr-report.json
        run: |
          echo "Publishing ANCHR status for commit: $GITHUB_HEAD_SHA"
          if [ ! -f "$ANCHR_REPORT_PATH" ]; then
            echo "No ANCHR report found — publishing neutral status"
            npm run set-pr-status || true
            exit 0
          fi
          echo "ANCHR report found — publishing decision"
          npm run set-pr-status || true
        continue-on-error: true

      - name: Abort if PR updated
        id: abort_updated
        run: |
          CURRENT=$(curl -sSf \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
            | jq -r '.head.sha // empty')
          if [ "$CURRENT" != "${{ github.event.pull_request.head.sha }}" ]; then
            echo "PR updated during run — skipping comment and check"
            echo "aborted=true" >> $GITHUB_OUTPUT
          else
            echo "aborted=false" >> $GITHUB_OUTPUT
          fi

      - name: Abort if PR closed
        id: abort_closed
        run: |
          STATE=$(curl -sSf \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
            | jq -r '.state // empty')
          if [ "$STATE" != "open" ]; then
            echo "PR closed — skipping comment and check"
            echo "aborted=true" >> $GITHUB_OUTPUT
          else
            echo "aborted=false" >> $GITHUB_OUTPUT
          fi

      - name: Read report and policy
        id: report
        if: steps.abort_updated.outputs.aborted != 'true' && steps.abort_closed.outputs.aborted != 'true'
        run: |
          mkdir -p artifacts
          if [ ! -f artifacts/anchr-report.json ]; then
            echo "action=retry" >> $GITHUB_OUTPUT
            echo "reason=ANCHR failed to produce report" >> $GITHUB_OUTPUT
            echo "run_id=" >> $GITHUB_OUTPUT
            exit 0
          fi
          RUN_ID=$(jq -r '.run.id // empty' artifacts/anchr-report.json)
          if [ -f artifacts/anchr-policy.json ]; then
            ACTION=$(jq -r '.action // "retry"' artifacts/anchr-policy.json)
            REASON=$(jq -r '.message // "unknown"' artifacts/anchr-policy.json)
          else
            ACTION="retry"
            REASON="No policy output"
          fi
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Post or update comment (convergent)
        id: comment_ctrl
        if: steps.abort_updated.outputs.aborted != 'true' && steps.abort_closed.outputs.aborted != 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          REPORT_PATH: artifacts/anchr-report.json
        run: |
          npx -y tsx@4 scripts/arcsight-pr-comment.ts || true
        continue-on-error: true

      - name: Post ANCHR inline review
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: npm run post-inline-review || true
        continue-on-error: true

      - name: Find existing check run
        id: check
        if: steps.abort_updated.outputs.aborted != 'true' && steps.abort_closed.outputs.aborted != 'true'
        run: |
          REF="${{ github.event.pull_request.head.sha }}"
          RUNS=$(curl -sSf \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/commits/$REF/check-runs?per_page=100")
          CHECK_ID=$(echo "$RUNS" | jq -r '.check_runs[] | select(.name == "ANCHR") | .id' | head -1)
          if [ -n "$CHECK_ID" ]; then
            echo "check_id=$CHECK_ID" >> $GITHUB_OUTPUT
            echo "has_check=true" >> $GITHUB_OUTPUT
          else
            echo "check_id=" >> $GITHUB_OUTPUT
            echo "has_check=false" >> $GITHUB_OUTPUT
          fi

      - name: Map action to conclusion
        id: conclusion
        if: steps.abort_updated.outputs.aborted != 'true' && steps.abort_closed.outputs.aborted != 'true'
        run: |
          ACTION="${{ steps.report.outputs.action }}"
          case "$ACTION" in
            merge)  echo "conclusion=success" >> $GITHUB_OUTPUT ;;
            block)  echo "conclusion=failure" >> $GITHUB_OUTPUT ;;
            review) echo "conclusion=failure" >> $GITHUB_OUTPUT ;;
            retry)  echo "conclusion=failure" >> $GITHUB_OUTPUT ;;
            *)      echo "conclusion=failure" >> $GITHUB_OUTPUT ;;
          esac

      - name: Create or update check run
        if: steps.abort_updated.outputs.aborted != 'true' && steps.abort_closed.outputs.aborted != 'true'
        run: |
          REF="${{ github.event.pull_request.head.sha }}"
          CONCLUSION="${{ steps.conclusion.outputs.conclusion }}"
          RUN_ID="${{ steps.report.outputs.run_id }}"
          REASON="${{ steps.report.outputs.reason }}"
          SUMMARY=$(printf 'ANCHR — Structural Gate\nrun.id: %s\n\n%s' "${RUN_ID:-—}" "$REASON")
          CHECK_ID="${{ steps.check.outputs.check_id }}"
          PAYLOAD=$(jq -n --arg c "$CONCLUSION" --arg r "$SUMMARY" '{ conclusion: $c, output: { title: "ANCHR", summary: $r } }')
          if [ -n "$CHECK_ID" ]; then
            curl -sSf -X PATCH \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "https://api.github.com/repos/${{ github.repository }}/check-runs/$CHECK_ID" || true
          else
            CREATE_PAYLOAD=$(jq -n --arg ref "$REF" --arg c "$CONCLUSION" --arg r "$SUMMARY" '{ name: "ANCHR", head_sha: $ref, status: "completed", conclusion: $c, output: { title: "ANCHR", summary: $r } }')
            curl -sSf -X POST \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              -d "$CREATE_PAYLOAD" \
              "https://api.github.com/repos/${{ github.repository }}/check-runs" || true
          fi
        continue-on-error: true
